$NetBSD: patch-ai,v 1.4 2011/09/06 11:20:19 obache Exp $

--- tftpyale.c.orig	1995-03-20 20:11:11.000000000 +0000
+++ tftpyale.c
@@ -2,8 +2,9 @@
 #include <string.h>
 #include <syslog.h>
 #include <ctype.h>
-#include <arpa/tftp.h>
 #include <sys/types.h>
+#include <arpa/inet.h>
+#include <arpa/tftp.h>
 #include <sys/stat.h>
 #include <netinet/in.h>
 #include "tftpyale.h"
@@ -95,7 +96,7 @@ addFileRestriction (ac, av)
 int	ac;
 char**	av;
 {
-	int list;
+	long list;
 
 	ac--; av++;
 	if (ac != 2) {
@@ -104,7 +105,7 @@ char**	av;
 	}
 
 	/* get list number */
-	list = atoi (av[1]);
+	list = atol (av[1]);
 	if (list <= 0) {
 		accessFormatError = "list argument not positive integer";
 		return 0;
@@ -157,27 +158,24 @@ struct stat* sb;
  * qualified (starts with '/') check to see if the
  * prefix matches the default directory.
  */
-static int
+static long
 getAccessList (fileName)
 char* fileName;
 {
-	unsigned int list;
+	unsigned long list;
 	char* rindex();
 
 	if (*fileName == '/') {
-		char* sep = rindex (fileName, '/');
-		int count = sep - fileName;
-
-		if (count > 0)
-			count--;
 		if (tftpDefaultDirectory
 		    && strncmp(fileName, tftpDefaultDirectory,
 				strlen(tftpDefaultDirectory))==0) {
-			fileName = sep+1;
+			fileName +=strlen(tftpDefaultDirectory);
+			if(*fileName == '/')
+				fileName++;
 		}
 	}
 
-	list = (int)dict_find (fileAccessDict, fileName);
+	list = (long)dict_find (fileAccessDict, fileName);
 
 	return list ? list : defaultAccessList;
 }
@@ -269,7 +267,7 @@ char**	argv;
 			continue;
 
 		cargv = config_fields(cnf);
-		switch ((int)dict_find (commandDict, cargv[0])) {
+		switch ((long)dict_find (commandDict, cargv[0])) {
 		  /* specify default directory */
 		  case CMD_DEFAULT_DIR:
 			if (cargc != 2)
@@ -481,7 +479,7 @@ char*	buf;
 
 static struct CMDS {
 	char* cmdName;
-	int cmdVal;
+	long cmdVal;
 } configCmds[] ={
 	"default-directory",	CMD_DEFAULT_DIR,
 	"defaultDirectory",	CMD_DEFAULT_DIR,
